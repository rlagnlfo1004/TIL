# 2-1 크로스 집계의 기본


### 크로스 집계

**트랜잭션 테이블에서 크로스 테이블로 변환하는 과정을 ‘크로스 집계’라고한다.**

1. **크로스 테이블**
    - 행과 열이 교차하는 부분에 숫자 데이터가 들어가는 테이블
    - 열이 늘어나기에, 데이터베이스에서 다루기 힘들다.
    - 원하는 데이터를 보기 편하다.
2. **트랜잭션 테이블**
    - 데이터는 행 방향으로만 증가하는 데이터베이스에서 주로 다루는 테이블이다.
<br><br>

책에서는 크로스 집계를 하는 여러 방법들을 소개한다.

- 스프레드시트의 피벗 테이블 기능에 의한 크로스 집계
- BI 도구에 의한 크로스 집계
- Pandas에 의한 크로스 집계
- SQL에 의한 테이블 집계
<br><br>

이때, 피벗 테이블에 대한 크로스 집계는 간편하지만, 데이터의 양의 너무 많으면 처리할 수 없다. BI 도구와 pandas라면, 수백만 레코드는 집계할 수 있지만, 그 이상은 역시나 힘들다. 따라서, **데이터를 먼저 ‘SQL로 집계’**하고, **시각화 도구로 크로스 집계** 하는 두 단계의 절차로 진행해야 한다. 전자는 **‘데이터 집계의 프로세스’**, 후자를 **‘시각화 프로세스’** 라고 한다.
<br><br>

### 데이터 집계 → 데이터 마트 → 시각화

데이터의 집계와 시각화 사이에 있는 것이 데이터 마트다. 이 **데이터 마트의 크기에 있어서, 시스템의 구성이 달라지며, 이는 trade off 관계**에 있다. 따라서, 필요에 따라 어느 정도의 정보를 남길 것인가를 결정해야 한다.
<br><br>

- **데이터 마트가 작다.**
    - 시각화하는 것이 간단해진다.
    - 원래 데이터에 포함된 정보를 잃어버리게 되어 시각화 프로세스에서 할 수 있는 일이 적어진다.
    - 피벗 테이블과 BI 도구를 사용해 대화적인 데이터 검색한다면, 정보 부족으로 곤란한 상황 발생한다.
- **데이터 마트가 크다.**
    - 데이터 집계의 프로세스에서 많은 정보를 남기는 것이다.
    - 데이터 마트가 거대화되어 좋은 시각화를 할 수 없다.
<br><br><br><br>

# 2-2 열 지향 스토리지에 의한 고속화


### 데이터베이스의 지연을 줄이기

메모리에 다 올라가지 않을 정도의 **대량의 데이터를 신속하게 집계**하려면, 미리 데이터를 집계에 적합한 형태로 변환하는 것이 필요하다. 데이터양이 증가함에 따라 집계에 걸리는 시간은 길어진다.
<br><br>

**3계층의 데이터 집계 시스템**

**데이터 레이크 -> 데이터 마트 -> 시각화 도구**

원 데이터는 용량적인 제약이 적어서 대량의 데이터를 처리할 수 있는 데이터 레이크와 데이터 웨어하우스에 저장한다. 거기에서 원하는 데이터를 추출하여 데이터 마트를 구축하고 여기에서는 항상 초 단위의 응답을 얻을 수 있도록 한다.

- **데이터 레이크 : Throughput 보장 (데이터 집계 - 수분 ~ 수시간)**
- **데이터 마트 : Latency 보장(크로스 집계 - 수초)**
<br><br>

### 데이터 처리의 지연

**데이터 마트**를 만들 때는 가급적 지연이 적은 데이터베이스가 있어야 한다. 크게 두 가지 선택이 있다.
<br><br>

**1. 모든 데이터를 메모리에 올리기**

- 수 GB의 데이터의 경우, MySQL이나 PostgreSQL 등의 일반적인 RDB가 데이터 마트에 적합하다.
- RDB는 지연이 적고, 많은 수의 클라이언트가 동시 접속해도 성능이 나빠지지 않으므로, 많은 사용자가 사용하는 **실제 운영 환경의 데이터 마트**로 적절하다.
- 하지만, RDB는 메모리가 부족하면 급격히 성능이 떨어지기에, 데이터 집계에서는 부적절하다.

**2. '압축'과 '분산'에 의해 지연 줄이기 - MPP 기술**

- 고속화를 위해 사용되는 기법이 **'압축'**과 **'분산'**이다. 데이터를 가능한 한 작게 압축하고 그것을 여러 디스크에 분산함으로써 데이터 로드에 따른 지연을 줄인다.
- 분산된 데이터를 읽기 위해 **멀티 코어를 활용하면서 디스크 I/O를 병렬 처리**한다.
- 이러한 아키텍쳐를 **MPP(massive parallel processing, 대규모 병렬 처리)**라 한다.(ex. Amazon Redshift, Google BigQuery)
- MPP는 데이터 집계에 최적화되어 있으며, 데이터 웨어하우스와 데이터 분석용의 데이터베이스에서 특히 많이 사용된다.
<br><br>

---
<br><br>

### 행 지향 데이터베이스

Oracle Database, MySQL 같은 일반적인 RDB는 행 지향 데이터베이스이다.

- 테이블의 각 행을 하나의 레코드 덩어리로 디스크에 저장한다.
- 새 레코드를 추가할 때, 파일의 끝에 데이터를 쓸 뿐이므로 빠르게 추가할 수 있다.
- 매일 발생하는 대량의 트랜잭션을 지연없이 처리하기 위해 **데이터 추가**를 효율적으로 하는 것이 특징이다.
- 데이터 검색을 고속화하기 위해 적절한 **인덱스(Index)**가 사용되도록 튜닝이 필요하다.
<br><br>

하지만, 데이터 분석에는 어떤 칼럼이 사용되는지 미리 알 수 없기에 Index가 도움이 되지 않는다. 필연적으로 대량의 데이터 분석은 항상 디스크 I/O를 동반한다. 따라서 인덱스에 의지하지 않는 고속화 기술이 필요하다.
<br><br>

### 열 지향 데이터베이스

데이터 분석에 사용되는 데이터베이스는 칼럼 단위의 집계에 최적화되어 있으며, '열 지향 데이터베이스(column-oriented databse)' 또는 '칼럼 지향 데이터베이스(columnar database)'라고 한다.

- Teradata, Amazon Redshint 등이 열 지향 데이터베이스이다.
- 인덱스에 의존하지 않는다.
- **칼럼마다, 데이터를 모아두고, 필요한 칼럼만을 로드하여 데이터 I/O를 줄인다.**
- **데이터의 압축 효율이 우수하다.**
- 집계는 빠르지만, 저장은 느리다.
<br><br>

### MPP 데이터베이스의 접근 방식

쿼리 지연을 줄일 또 다른 방법은 MPP 아키텍쳐에 의한 데이터 처리의 병렬화다.

- **행 지향 데이터베이스 :** 하나의 쿼리는 하나의 스레드에서 실행된다. 많은 쿼리를 동시에 실행함으로써 여러 개의 CPU 코어를 활용할 수 있지만, 개별 쿼리가 분산 처리되는 것은 아니다.
- **열 지향 데이터베이스 :** 디스크에서 대량의 데이터를 읽기 때문에 1번의 쿼리 실행 시간이 길어진다. 압축된 데이터의 전개 등으로 CPU 리소스를 필요로 하므로 멀티 코어를 활용하여 고속화하는 것이 좋다.
<br><br>

**MPP에서는 하나의 쿼리를 여러 태스크(task)로 나누고, 이를 병렬로 실행한다.**
<br><br>

### MPP 데이터베이스와 대화형 쿼리 엔진

이때, 디스크로부터 로드가 병목 현상이 발생하지 않도록 데이터가 고르게 분산되어야 한다. 하드웨어 수준에서 데이터 집계에 최적화된 데이터베이스를 **MPP 데이터베이스**라고 한다.

MPP의 아키텍처는 **Hadoop과 함께 사용되는 대화형 쿼리 엔진**으로도 채택되고 있다. 이 경우 데이터를 저장하는 것은 분산 스토리지의 역할이다.  따라서, Hadoop 상에서 열 지향 스토리지를 만들기 위해 여러 라이브러리가 개발되고 있다.
<br><br><br><br>

# 2-3 **애드 혹 분석과 시각화 도구**

### **Jupyter Notebook 애드 혹 분석**

- **분석 과정 기록한다.**
<br><br>

### **대시보드 도구**

- **정기적으로 집계 결과 시각화한다.**
- 새로운 그래프를 쉽게 추가할 수 있는 것이 중요하다.
- 정해진 지표와 일상적인 변화 모니터링 시 대시보드를 사용한다.
- 최신의 집계 결과 즉시 확인 가능하다.
- 실시간 데이터 업데이트 가능하다.
<br><br>

### BI 도구

- 대화형 데이터 탐색이 중요하다.
- 시간 들여 차분히 데이터 보는 경우에 사용한다.
- **몇 개월 단위의 장기적인 데이터의 추이를 시각화 한다.**
- **집계의 조건을 세부적으로 바꿀 수 있는 대시보드를 만들기 위한 도구이다.**
- **데이터 마트에서 하나의 테이블을 만들고 다수의 대시보드를 만든다.**
<br><br><br><br>

# 2-4 데이터 마트의 기본 구조


BI 도구에서 대화형으로 데이터를 참고하려고 하면, 시각화에 필요한 정보만을 모은 데이터 마트가 필수적이다. 
<br><br>

### 시각화에 적합한 데이터 마트 만들기

OLAP(online analytical processing)는 데이터 집계를 효율화하는 방법 중 하나이다. **다차원 모델의 데이터 구조**를 **MDX(multidimensional expressions)** 등의 쿼리 언어로 집계한다. 데이터 분석을 위해 만들어진 다차원 데이터를 **‘OALP 큐브’**라고 한다. 이를 크로스 집계하는 구조가 OALP이다.
<br><br>

### MPP 데이터베이스와 비정규화 테이블

최근에는, BI 도구와 MPP 데이터베이스를 조합하여 크로스 집계하는 경우가 증가하고 있다. BI 도구로 그래프를 만들기 위해서는 **‘다차원 모델’**을 설계한다. 하지만, MPP 데이터베이스에 다차원 모델의 개념은 없기 때문에, 이를 대신해 **‘비정규화 테이블’**을 준비한다. 이를 통해 OLAP와 동등한 시각화를 할 수 있다.
<br><br>

**즉, 정리하자면 ‘시각화에 적합한 데이터 마트를 만드는 것’은 ‘BI 도구를 위한 비정규화 테이블 만드는 프로세스’ 이다.**
<br><br>

---
<br><br>

### 트랜잭션과 마스터

- **트랜잭션(transaction):** 시간과 함께 생성되는 데이터 기록, 한번 기록시 변화하지 않는다.
- **마스터(master):** 트랜잭션에 참고되는 각종 정보가 마스터이다. 상황에 따라 다시 쓰인다.
<br><br>

### 팩트 테이블과 디멘전 테이블

- **팩트 테이블(fact table):** DWH에서 트랜잭션처럼 사실이 기록된 것이다. 판매액과 같이 집계 기반의 숫자 데이터이다.
- **디멘전 테이블(dimension table):** 팩트 테이블 참고되는 마스터 데이터 등의 데이터 분류를 위한 속성값이다.
<br><br>

### 스타 스키마와 비정규화

- **스타 스키마 :** 팩트 테이블 중심으로 여러 디멘전 테이블 결합한 형태이다. 단순해서 이해하기 쉽고, 데이터 분석 용이하다. 팩트 테이블에는 ID와 같은 key값만을 두어 성능을 효율화 한다.
- **비정규화 테이블 :** MPP 데이터 베이스와 같은 **열지향 스토리지**에 의해, 칼럼의 수가 아무리 늘어나도 성능에 영향을 주지 않는다. 따라서, 모든 칼럼을 포함하여 쿼리의 실행 시에는 테이블 결합을 하지 않는, **‘하나의 거대한 팩트 테이블’**을 **비정규화 테이블**이라 한다.
<br><br>

**데이터 웨어하우스의 구조로는 스타 스키마**가 좋다. 데이터 축적하는 단계에서 팩트 테이블과 디맨전 테이블로 분리하고, **분석(데이터 마트를 만드는) 단계가 된 후에 결합해 비정규화 테이블**을 만든다. 
<br><br>

---
<br><br>

### **다차원 모델 시각화에 대비하여 테이블 추상화**

비정규화 테이블을 준비했다면,  이제 **‘다차원 모델’**에 의해 추상화 한다. **칼럼**을 **‘디멘전(dimension)’**과 ‘**측정값(measure)’**로 분류한다.

- 디멘젼: 크로스 집계의 행과 열이다.
- 측정값: 숫자 데이터와 집계 방법이다.
<br><br>

다차원 모델의 정의는 나중에 확장 할 수 있다. 예를들어 상품별 그룹으로 시각화 하고싶으면 제품 그룹이라는 새로운 디멘젼을 추가하고 시각화한다. 데이터 분석의 요구에 따라 비정규화 테이블에는 다수의 칼럼이 추가되고, 거기에서 다수의 그래프가 생성된다. **이런 비정규화 테이블 모은 것이 BI 도구를 위한 데이터 마트이다.** 비정규화 테이블 업데이트 하면 모든 그래프 업데이트된다.